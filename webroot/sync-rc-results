#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# function parasol() {
#     parallel -j 1 --halt now,fail=1 $@
# }
function parasol() {
    parallel $@
}
export -f parasol


function club_detail_page() {
    local VENUE_ID="$1"
    local PAGE="$2"
    local OUT="$(curl -s "https://www.rc-results.com/viewer/Main/VenueMeetings?venueId=${VENUE_ID}&page=$PAGE")"
    echo "$OUT" | pup 'table tbody a attr{href}' | sed 's/.*=//'
    PAGE="$(echo "$OUT" | pup 'table tfoot a attr{href}' | sed 's/.*=//' | awk -v PAGE="$PAGE" '{ if ($1 > PAGE) { print $1 } }' | head -n1)"
    if [ -n "$PAGE" ]; then
        club_detail_page "$VENUE_ID" "$PAGE"
    fi
}


function club_detail() {
    local VENUE_ID="$1"
    club_detail_page "$VENUE_ID" 1
}


function filter_by_dir() {
    if [ -d "rc-results/$1/$2" ]; then
        exit
    fi
    echo "$2"
}
export -f filter_by_dir


function stream_event_overview() {
    local VENUE_ID="$1"
    local MEETING_ID="$2"
    curl -s "https://www.rc-results.com/viewer/Main/MeetingSummary?meetingId=${MEETING_ID}" | pup 'div.container a attr{href}' | grep 'RaceResult' | awk -F '=' -v SD="$VENUE_ID" -v EVT="$MEETING_ID" '{ print SD, EVT, $NF }'
}
export -f stream_event_overview

function stream_event_heat_overview() {
    local VENUE_ID="$1"
    local MEETING_ID="$2"
    local RACE_ID="$3"
    local OUT="$(curl "https://www.rc-results.com/viewer/Main/RaceResult?raceId=$RACE_ID")"
    local VENUE="$(echo "$OUT" | pup 'a[href^="/viewer/Main/VenueMeetings?venueId=1093"]' | pup a text{} | awk '/[A-Z0-9]/ { print $0 }')"
    local MEETING="$(echo "$OUT" | pup 'a[href^="/viewer/Main/MeetingSummary?meetingId="]' | pup 'a text{}' | awk '/[A-Z0-9]/ { print $0 }')"
    local HEAT_NAME="$(echo "$OUT" | pup h3 text{} | awk 'NR == 1 { print $0 }')"
    local RACE_NAME="$(echo "$OUT" | pup h3 text{} | awk 'NR == 2 { print $0 }')"
    local TABLE="$(echo "$OUT" | pup "table" | html-table-as-json)"
    local DRIVER_IDS="$(echo "$OUT" | pup 'table a attr{href}' | awk -F '=' -v SD="$VENUE_ID" -v EVT="$MEETING_ID" -v RC="$RACE_ID" '{ print SD, EVT, RC, $NF }')"
    echo "$VENUE"
    echo "$MEETING"
    echo "$RACE_NAME"
    echo "$HEAT_NAME"
    echo "$TABLE"
    echo "$DRIVER_IDS"
}


function stream_event_heat_results() {
    local VENUE_ID="$1"
    local MEETING_ID="$2"
    local RACE_ID="$3"
    local DRIVER_ID="$4"
    # local OUT="$(curl "https://www.rc-results.com/viewer/Main/DriverResult?raceId=${RACE_ID}&driverId=${DRIVER_ID}")"
    local OUT="$(cat ./individual.html)"
    local OVERVIEW="$(echo "$OUT" | pup table.table-condensed | html-table-as-json -k)"
    echo "$OVERVIEW"
    local LAPS="$(echo "$OUT" | pup table.table-ultra-condensed | html-table-as-json -k)"
    echo "$LAPS"
}


# https://www.rc-results.com/viewer/Main/MeetingSummary?meetingId=9937

# club_detail 1093 | parasol filter_by_dir 1093 | stream_event_overview 1093 9937
# stream_event_overview 1093 9937
# stream_event_heat_overview 1093 9937 188101
stream_event_heat_results 1093 9937 188101 225016

