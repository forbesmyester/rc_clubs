<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RC Race Stats</title>
  <!--<meta name="viewport" content="width=device-width,initial-scale=1" />-->
  <meta name="description" content="" />
  <link href="https://cdn.jsdelivr.net/npm/modern-normalize@v2.0.0
/modern-normalize.min.css" rel="stylesheet">
  <!--<link rel="icon" href="favicon.png">-->
  <script src="https://unpkg.com/@antonz/sqlean/dist/sqlean.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 1em; }
    .loading #loading-container { display: flex; }
    .active-stage-1 #stage1 { font-weight: bold; }
    .active-stage-1 #stage2 { display: none; }
    .active-stage-1 #stage3 { display: none; }
    .active-stage-2 #stage2 { font-weight: bold; }
    .active-stage-2 #stage3 { display: none; }
    .active-stage-3 #stage3 { font-weight: bold; }

    .bottom-text { margin: 4em; }


    .spinner {
      width: 64px;
      height: 64px;
      border: 8px solid;
      border-color: #3d5af1 transparent #3d5af1 transparent;
      border-radius: 50%;
      animation: spin-anim 1.2s linear infinite;
    }

    @keyframes spin-anim {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    #loading-container {
      width: 100%;
      height: 100vh;
      display: none;
      justify-content: center;
      align-items: center;
      position: fixed;
      background: #000;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h1>RC Race Stats</h1>
  <!--[if IE]><div style="width: 100%; position: fixed; z-index: 1000; bottom: 0; left: 0; background: lightgray;"><p>Outdated browser dectected. Please use a modern browser for a better browsing experience.</p><div onClick="parentNode.remove()">Close [X]</div></div><![endif]-->
  <div id="input" class="loading">
    <div id="loading-container">
      <div class="spinner"></div>
    </div>
    <div id="stage1">
      <p>First select your club: <select id="club"></select></p>
    </div>
    <div id="stage2">
      <p>Then select a driver you want to view: <select id="driver"></select></p>
    </div>
    <div id="stage3">
      <p>Then select a class they raced in: <select id="race_class"></select></p>
    </div>
  </div>
  <div id="chart_holder">
    <p class="bottom-text">
      NOTE: After selecting club (first drop down, be patient, it downloads a (rather large) SQLite database, so it's not fast. When complete you'll get a list of drivers in the second drop down.
    </p>
  </div>
  <div id="download" class="bottom-text"></div>
</body>
<script>

  (function() {
  let option = document.createElement('option');
  option.innerText = 'SELECT ONE'
  document.getElementById('club').appendChild(option);
  }());


  fetch('/db/index.json')
    .then(o => o.json())
    .then((json) => json.map(j => j.replace(/\.json$/, '')))
    .then((clubs) => {
      let opts = clubs.map((club) => {
        let option = document.createElement('option');
        option.innerText = club
        option.value = club
        document.getElementById('club').appendChild(option);
        document.getElementById('input').classList.remove('loading');
        document.getElementById('input').classList.add('active-stage-1');
      });
    });


  function dbAll(db, sql, bind) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        const params = { sql, bind, rowMode: 'object', returnValue: 'resultRows' };
        console.log({params});
        resolve(db.exec(params));
      }, 0);
    });
  }

  function addDrivers(drivers) {
    let selectEl = document.getElementById('driver');
    selectEl.innerHTML = '';
    let option = document.createElement('option');
    option.innerText = 'SELECT ONE'
    selectEl.appendChild(option);
    drivers.forEach((driver) => {
      let option = document.createElement('option');
      option.innerText = driver.driver_name;
      option.value = driver.driver_id;
      selectEl.appendChild(option);
    });
  }

  let db;

  function addDownload(url) {
    let ahref = document.createElement('a');
    ahref.setAttribute('href', url);
    ahref.innerText = 'Download the database'
    document.getElementById('download').appendChild(ahref);
    let span = document.createElement('span');
    span.innerText = ' And use '
    document.getElementById('download').appendChild(span);
    let ahref2 = document.createElement('a');
    ahref2.setAttribute('href', 'https://sqlitebrowser.org/');
    ahref2.innerText = 'DB Browser for SQLite'
    document.getElementById('download').appendChild(ahref2);
  }


  document.getElementById('club').addEventListener('change', function(event) {
    document.getElementById('input').classList.add('loading');
    document.getElementById('input').classList.add('active-stage-2');
    document.getElementById('input').classList.remove('active-stage-1');
    let club = event.target.value;
    fetch('db/' + club)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error, status = ${response.status}`);
        }
        return response.arrayBuffer();
      })
      .then(async (arrayBuffer) => {
        const sqlite3 = await sqlite3InitModule({
            print: console.log,
            printErr: console.error,
        });
        const p = sqlite3.wasm.allocFromTypedArray(arrayBuffer);
        const db = new sqlite3.oo1.DB();
        const rc = sqlite3.capi.sqlite3_deserialize(
          db.pointer, 'main', p, arrayBuffer.byteLength, arrayBuffer.byteLength,
          sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE
        );
        db.checkRc(rc);
        addDownload('db/' + club);
        return db;
      })
      .then((inDb) => db = inDb)
      .then(async () => {
        addDrivers(await dbAll(db, 'select * from driver order by driver_name', []));
        document.getElementById('input').classList.remove('loading');
        return db;
      })
      .catch((e) => {
        console.log(e);
      });
  });

  document.getElementById('driver').addEventListener('change', async function(event) {
    document.getElementById('input').classList.add('loading');
    document.getElementById('input').classList.add('active-stage-3');
    document.getElementById('input').classList.remove('active-stage-2');
    let usedClassesSql = `
      select distinct race_class_name,race_class.race_class_id
      from race_driver
      inner join race on race.race_id = race_driver.race_id
      inner join race_class on race_class.race_class_id = race.race_class_id
      where race_driver.driver_id = ?
      `;
    let classes = await dbAll(db, usedClassesSql, [event.target.value]);
    let selectEl = document.getElementById('race_class');
    selectEl.innerHTML = '';
    let option = document.createElement('option');
    option.innerText = 'SELECT ONE'
    selectEl.appendChild(option);
    console.log(classes);
    classes.forEach((cls) => {
      let option = document.createElement('option');
      option.innerText = cls.race_class_name;
      option.value = cls.race_class_id;
      selectEl.appendChild(option);
    });
    document.getElementById('input').classList.remove('loading');
  });

  document.getElementById('race_class').addEventListener('change', async function(event) {
    document.getElementById('input').classList.add('loading');
    let results = await dbAll(
      db,
      fullSQL,
      [document.getElementById('driver').value, event.target.value]
    );
    drawGraph(results);
    document.getElementById('input').classList.remove('loading');
  });

function drawGraph(results) {

  let ctx = document.createElement('canvas');
  document.getElementById('chart_holder').innerHTML = '';
  document.getElementById('chart_holder').appendChild(ctx);

  const data = {
    labels: [],
    datasets: [{
      label: 'My First Dataset',
      data: [65, 59, 80, 81, 56, 55, 40],
      fill: false,
      borderColor: 'rgb(75, 192, 192)',
      tension: 0.1
    }]
  };

  function getDataFrom(label) {
    let data = results.map((res) => res[label]);
    return { label, borderWidth: 1, data }
  }

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: results.map((res) => res.event_date),
      datasets: [
        getDataFrom('person_avg_lap_time_ms'),
        getDataFrom('race_1_winner_avg_lap_time_ms'),
        // getDataFrom('race_1_top_half_avg_lap_time_ms'),
        getDataFrom('race_2_winner_avg_lap_time_ms'),
        // getDataFrom('race_2_top_half_avg_lap_time_ms'),
        getDataFrom('race_3_winner_avg_lap_time_ms'),
      ]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

}

let fullSQL = `
      with
      driver_to_view as (
      	select driver_id from driver where driver.driver_id = ?
      ),
      find_finals as (
      	select
      		race.race_class_id,
      		heat.event_id,
      		heat.heat_id,
      		case when heat.heat_id = max(heat.heat_id) over (partition by heat.event_id) THEN true else false end as is_final,
      		race.race_number,
      		race.race_id,
      		race.race_length,
      		race.race_logged_class_name
      	from race
      	inner join race_class on race_class.race_class_id = race.race_class_id
      	inner join heat on heat.heat_id = race.heat_id
      	order by heat.event_id desc, race_class.race_class_id desc, heat.heat_id desc, race.race_number desc
      ),
      identify_finals as (
      	select
      	event_id,
      	race_class_id,
      	row_number() over (partition by is_final, event_id, race_class_id order by race_number desc) as race_speed_rank,
      	race_id,
      	heat_id
      	from find_finals where is_final = true
      	order by event_id desc
      ),
      interesting_race_1 as (
      	select race.race_id, event_id, race_class_id, race_driver.driver_id from race_driver
      	inner join race on race.race_id = race_driver.race_id
      	inner join heat on heat.heat_id = race.heat_id
      	where race_driver.driver_id in (select driver_id from driver_to_view)
      ),
      interesting_race as (
      	select distinct
      		interesting_race_1.event_id,
      		interesting_race_1.race_class_id,
      		race.race_id,
      		race.race_number,
      		race.race_logged_class_name
      	from interesting_race_1
      	inner join heat on heat.event_id = interesting_race_1.event_id
      	inner join race on race.heat_id = heat.heat_id
      	where race.race_class_id = interesting_race_1.race_class_id
      ),
      driver_laps_1 as (
      	SELECT
      		race_driver.race_id,
      		race_driver.driver_id,
      		max(race_driver_laps.race_driver_laps_lap_number) as lap_count,
      		sum(race_driver_laps.race_driver_laps_time_millisecond) as total_time
      	FROM
      	race_driver_laps
      	inner join race_driver on race_driver.race_driver_id = race_driver_laps.race_driver_id
      	group by race_driver.race_id, race_driver.driver_id
      ),
      driver_laps_2 as (
      	select
      		row_number() over (partition by race_id order by lap_count desc, total_time asc) as pos,
      		lap_count,
      		total_time,
      		total_time / lap_count as avg_lap_time,
      		race_id,
      		driver_id
      	from driver_laps_1
      	order by lap_count desc, total_time asc
      ),
      driver_laps_3 as (
      	select
      		*,
      		case when pos = 1 then true else false end as is_winner,
      		case when pos = (max(pos) over (partition by race_id) / 2) then true else false end as is_top_half,
      		case when driver_id in (select driver_id from driver_to_view) then true else false end as is_me
      	from driver_laps_2
      	order by lap_count desc, total_time asc
      ),
      driver_laps as (
      	select * from driver_laps_3
      	where is_top_half or is_winner or is_me
      ),
      stats as (
      	select
      		event.event_id,
      		event.event_date,
      		race_class.race_class_name,
      		race_class.race_class_id,
      		identify_finals.race_speed_rank,
      		driver.driver_name,
      		driver.driver_id,
      		driver_laps.pos,
      		driver_laps.driver_id,
      		total_time,
      		lap_count,
      		avg_lap_time,
      		is_winner,
      		is_top_half,
      		interesting_race.race_logged_class_name,
      		is_me
      	from identify_finals
      	inner join driver_laps on driver_laps.race_id = identify_finals.race_id
      	inner join race_class on race_class.race_class_id = identify_finals.race_class_id
      	inner join event on event.event_id = identify_finals.event_id
      	inner join driver on driver.driver_id = driver_laps.driver_id
      	inner join interesting_race on interesting_race.race_id = identify_finals.race_id
      	order by event_date desc, race_class.race_class_id desc, race_speed_rank asc, pos asc
      ),
      speed_rank_1_winner as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_winner and race_speed_rank = 1
      ),
      speed_rank_2_winner as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_winner and race_speed_rank = 2
      ),
      speed_rank_3_winner as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_winner and race_speed_rank = 3
      ),
      speed_rank_1_top_half as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_top_half and race_speed_rank = 1
      ),
      speed_rank_2_top_half as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_top_half and race_speed_rank = 2
      ),
      speed_rank_3_top_half as (
      	select
      		event_id,
      		race_class_id,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_top_half and race_speed_rank = 3
      ),
      mine as (
      	select
      		event_id,
      		event_date,
      		race_speed_rank,
      		race_class_id,
      		race_class_name,
      		avg_lap_time,
      		driver_name
      	from stats
      	where is_me
      )
      select
      	mine.event_date as event_date,
      	mine.race_class_name as class_name,
      	mine.driver_name as person_name,
      	mine.race_speed_rank as person_speed_race,
      	mine.avg_lap_time as person_avg_lap_time_ms,
      	speed_rank_1_winner.avg_lap_time as race_1_winner_avg_lap_time_ms,
      	speed_rank_1_winner.driver_name as race_1_winner_driver_name,
      	speed_rank_2_winner.avg_lap_time as race_2_winner_avg_lap_time_ms,
      	speed_rank_2_winner.driver_name as race_2_winner_driver_name,
      	speed_rank_3_winner.avg_lap_time as race_3_winner_avg_lap_time_ms,
      	speed_rank_3_winner.driver_name as race_3_winner_driver_name,
      	speed_rank_1_top_half.avg_lap_time as race_1_top_half_avg_lap_time_ms,
      	speed_rank_1_top_half.driver_name as race_1_top_half_driver_name,
      	speed_rank_2_top_half.avg_lap_time as race_2_top_half_avg_lap_time_ms,
      	speed_rank_2_top_half.driver_name as race_2_top_half_driver_name,
      	speed_rank_3_top_half.avg_lap_time as race_3_top_half_avg_lap_time_ms,
      	speed_rank_3_top_half.driver_name as race_3_top_half_driver_name
      from mine
      left join speed_rank_1_winner on speed_rank_1_winner.race_class_id = mine.race_class_id and speed_rank_1_winner.event_id = mine.event_id
      left join speed_rank_2_winner on speed_rank_2_winner.race_class_id = mine.race_class_id and speed_rank_2_winner.event_id = mine.event_id
      left join speed_rank_3_winner on speed_rank_3_winner.race_class_id = mine.race_class_id and speed_rank_3_winner.event_id = mine.event_id
      left join speed_rank_1_top_half on speed_rank_1_top_half.race_class_id = mine.race_class_id and speed_rank_1_top_half.event_id = mine.event_id
      left join speed_rank_2_top_half on speed_rank_2_top_half.race_class_id = mine.race_class_id and speed_rank_2_top_half.event_id = mine.event_id
      left join speed_rank_3_top_half on speed_rank_3_top_half.race_class_id = mine.race_class_id and speed_rank_3_top_half.event_id = mine.event_id
      where event_date not like '2023-07-15%'  and mine.race_class_id = ?
      order by event_date asc, class_name
    `;


</script>
</html>
